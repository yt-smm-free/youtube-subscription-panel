<%- include('../layout', { showNav: true }) %>

<div class="admin-campaign-detail">
    <div class="campaign-detail-header">
        <h2 class="glitch-text">Campaign Details</h2>
        <div class="campaign-detail-actions">
            <a href="/admin/campaigns" class="btn btn-secondary">Back to Campaigns</a>
            <% if (campaign.status === 'pending') { %>
                <button id="execute-campaign" class="btn btn-primary" data-id="<%= campaign._id %>">Execute Campaign</button>
            <% } %>
        </div>
    </div>
    
    <div class="campaign-overview">
        <div class="campaign-channel">
            <% if (campaign.thumbnailUrl) { %>
                <img src="<%= campaign.thumbnailUrl %>" alt="<%= campaign.channelName %>" class="channel-thumbnail-large">
            <% } %>
            <div class="channel-info">
                <h3><%= campaign.channelName %></h3>
                <a href="<%= campaign.channelUrl %>" target="_blank" class="channel-link">View Channel <span class="external-link-icon">â†—</span></a>
            </div>
        </div>
        
        <div class="campaign-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path fill="#00ff00" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h4>Status</h4>
                    <p class="stat-value">
                        <span class="status-badge status-<%= campaign.status %>">
                            <%= campaign.status %>
                        </span>
                    </p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path fill="#00ff00" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h4>Target</h4>
                    <p class="stat-value"><%= campaign.targetSubscribers || 'All Users' %></p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path fill="#00ff00" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h4>Actual</h4>
                    <p class="stat-value"><%= campaign.actualSubscribers || 0 %></p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" width="32" height="32">
                        <path fill="#00ff00" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <h4>Created</h4>
                    <p class="stat-value"><%= new Date(campaign.createdAt).toLocaleString() %></p>
                </div>
            </div>
            
            <% if (campaign.completedAt) { %>
                <div class="stat-card">
                    <div class="stat-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32">
                            <path fill="#00ff00" d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                        </svg>
                    </div>
                    <div class="stat-content">
                        <h4>Completed</h4>
                        <p class="stat-value"><%= new Date(campaign.completedAt).toLocaleString() %></p>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
    
    <div class="campaign-detail-section">
        <h3 class="section-title">Subscription Results</h3>
        
        <div class="terminal-table">
            <div class="terminal-header">
                <span class="terminal-button red"></span>
                <span class="terminal-button yellow"></span>
                <span class="terminal-button green"></span>
                <span class="terminal-title">subscription_results</span>
            </div>
            <div class="terminal-body">
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: <%= campaign.subscribers && campaign.subscribers.length > 0 ? (campaign.subscribers.filter(s => s.status === 'success').length / campaign.subscribers.length) * 100 : 0 %>%"></div>
                    </div>
                    <div class="progress-stats">
                        <span class="success-count"><%= campaign.subscribers ? campaign.subscribers.filter(s => s.status === 'success').length : 0 %> Successful</span>
                        <span class="failed-count"><%= campaign.subscribers ? campaign.subscribers.filter(s => s.status === 'failed').length : 0 %> Failed</span>
                        <span class="pending-count"><%= campaign.subscribers ? campaign.subscribers.filter(s => s.status === 'pending').length : 0 %> Pending</span>
                    </div>
                </div>
                
                <% if (campaign.subscribers && campaign.subscribers.length > 0) { %>
                    <table class="data-table" id="subscribers-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Status</th>
                                <th>Subscribed At</th>
                                <th>Error Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% campaign.subscribers.forEach(function(subscriber) { %>
                                <tr class="subscriber-row status-<%= subscriber.status %>">
                                    <td><%= subscriber.userId %></td>
                                    <td>
                                        <span class="status-badge status-<%= subscriber.status %>">
                                            <%= subscriber.status %>
                                        </span>
                                    </td>
                                    <td><%= subscriber.subscribedAt ? new Date(subscriber.subscribedAt).toLocaleString() : '-' %></td>
                                    <td><%= subscriber.errorMessage || '-' %></td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                <% } else { %>
                    <div class="no-data-message">
                        <p>No subscription data available yet. Execute the campaign to start subscribing users.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
    
    <div class="campaign-detail-section">
        <h3 class="section-title">Available Users</h3>
        
        <div class="terminal-mini">
            <div class="terminal-header">
                <span class="terminal-button red"></span>
                <span class="terminal-button yellow"></span>
                <span class="terminal-button green"></span>
                <span class="terminal-title">user_availability</span>
            </div>
            <div class="terminal-body">
                <div class="line">$ <span class="command">checking_authorized_users</span></div>
                <div class="line">$ <span class="response">Found <%= authorizedUsers %> authorized users available for subscription</span></div>
                <div class="line">$ <span class="command">campaign_status</span></div>
                <div class="line">$ <span class="response">Campaign is <%= campaign.status %></span></div>
                <% if (campaign.status === 'pending') { %>
                    <div class="line">$ <span class="command">ready_to_execute</span></div>
                    <div class="line">$ <span class="response">Campaign is ready to be executed</span></div>
                <% } else if (campaign.status === 'in-progress') { %>
                    <div class="line">$ <span class="command">execution_status</span></div>
                    <div class="line">$ <span class="response">Campaign is currently being executed</span></div>
                <% } else if (campaign.status === 'completed') { %>
                    <div class="line">$ <span class="command">completion_stats</span></div>
                    <div class="line">$ <span class="response">Campaign completed with <%= campaign.actualSubscribers || 0 %> successful subscriptions</span></div>
                <% } else if (campaign.status === 'failed') { %>
                    <div class="line">$ <span class="command">failure_analysis</span></div>
                    <div class="line">$ <span class="response">Campaign failed to complete. Check error logs.</span></div>
                <% } %>
                <div class="line">$ <span class="cursor"></span></div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const executeCampaignBtn = document.getElementById('execute-campaign');
        
        if (executeCampaignBtn) {
            executeCampaignBtn.addEventListener('click', function() {
                const campaignId = this.getAttribute('data-id');
                
                if (confirm('Are you sure you want to execute this campaign? This will subscribe all authorized users to the channel.')) {
                    // Disable button and show loading
                    this.disabled = true;
                    this.textContent = 'Processing...';
                    
                    fetch(`/admin/campaigns/${campaignId}/execute`, {
                        method: 'POST'
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(`Campaign executed successfully: ${data.successCount} successful subscriptions, ${data.failCount} failed`);
                                location.reload();
                            } else {
                                alert('Failed to execute campaign: ' + data.message);
                                this.disabled = false;
                                this.textContent = 'Execute Campaign';
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while executing the campaign');
                            this.disabled = false;
                            this.textContent = 'Execute Campaign';
                        });
                }
            });
        }
    });
</script>